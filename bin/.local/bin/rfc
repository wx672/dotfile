#!/bin/bash

cmdchk sk rg fd || exit 127

usage(){
	cat <<EOF
${0##*/} - Command line RFC viewer

Example usage:
	- ${0##*/} 1180
	- ${0##*/} -s <search string>
	- ${0##*/} -h
EOF
	exit ${1:-0}
}

search(){
	local idx="/usr/share/doc/RFC/rfc-index.txt.gz"
	[[ -f "$idx" ]] || { echo $idx: file not found.; exit 1; }

	IDX=$(gzip -cd $idx | sed -e 's/^$/~/' -e 's/ \+/ /' | tr '\n' ' ' | tr '~' '\n' | \
			  rg -i --color=always "$1" | sk -e10 --ansi | choose 0)
	
	rfc $(( 10#$IDX )) # 10# means base 10
}

while getopts :hs: OPT; do
	case $OPT in
		s) search "$OPTARG"; exit 0 ;;
		?) usage ;;
	esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

[ "$*" ] || usage 2
	
if [ -d "/usr/share/doc/RFC/" ]; then
	RFCBASE="/usr/share/doc/RFC/"

	DOC=$(sk < <(fd --full-path --type file "rfc$1\." "$RFCBASE") -e10)
else
	RFCBASE="https://www.rfc-editor.org/rfc"
	RFCLOCAL="/usr/local/share/doc/RFC"

	cd $RFCLOCAL || sudo mkdir -p $RFCLOCAL

	DOC=$(sk < <(fd --full-path --type file "rfc$1\." "$RFCLOCAL") -e10)
	
	[[ "$DOC" ]] || {
		sudo curl --remote-name-all --output-dir $RFCLOCAL $RFCBASE/rfc$1.{txt,html}
		DOC=$(sk < <(/bin/ls $RFCLOCAL/rfc$1.*) -e10)
		[[ "$DOC" ]] || {
			echo "rfc-$1 not found."
			exit 1
		}
	}
fi

case $DOC in
	*.txt*)
		less $DOC; exit 0
		;;
	*.html.gz)
		cmdchk w3m || exit 127
		w3m -T text/html < <(gzip -cd $DOC); exit 0
		;;
	*.html)
		cmdchk w3m || exit 127
		w3m -T text/html $DOC; exit 0
		;;
	*.json)
		cmdchk jless || exit 127
		jless $DOC
		;;
	*.pdf)
		cmdchk mupdf || exit 127
		mupdf $DOC; exit 0
		;;
	*.pdf.gz)
		cmdchk zathura || exit 127
		gzip -cd $DOC | zathura -; exit 0
		;;
	*) usage ;;
esac
