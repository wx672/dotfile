#!/bin/bash

cmdchk sk fd rg mupdf zathura || exit 127

SKOPTS="--exact --select-1 --exit-0 --no-multi --keep-right"
FDOPTS="--fixed-strings"
RGOPTS="--no-line-number --fixed-strings --max-columns=0"
MUOPTS="-C FDF6E3"
 
MUPDF="$(command -v mupdf-gl) $MUOPTS" || {
   MUPDF="$(command -v mupdf) $MUOPTS"
}
MUPDF="setsid -f $MUPDF"

unset TXT PTH DEBUG

PDFHIST="$HOME/.pdf_history"
[[ -e $PDFHIST ]] || touch $PDFHIST

usage() {
  cat <<EOF
${0##*/} - A lazy PDF viewer.

Usage: ${0##*/} [-e] [-t -p -D <pattern string>] 
  -e  edit $PDFHIST file
  -t  text mode (open pdf with 'less')
  -p  output full path to the file
  -D  enable debug mode
EOF

  exit ${1:-0}
}

chkPATTERN() {

  [[ "$1" ]] || return 0 #if $1 is empty

  [[ $DEBUG ]] && {
	  echo '[chkPATTERN] $*' is: ${*:-empty}
  }

  # valid file, e.g. /tmp/tmp.pdf or tmp.pdf
  [[ $(file --mime-type -b "$*") == "application/pdf" ]] && return 1
  
  return 2 #if $1 is a random string
}

openPDF() {

  [[ $1 ]] || exit 0

  [[ $DEBUG ]] && {
	  echo '[openPDF] $* is:' ${*:-empty}
  }

  # if not in PDFHIST, add it
  local FULLPTH="$(realpath "$*")"
  rg -qF "$FULLPTH" "$PDFHIST" || {
      echo "$FULLPTH" >> "$PDFHIST"
      echo "$FULLPTH" is added into $PDFHIST
    }

  [[ $DEBUG ]] && {
    echo '[openPDF] $* is ' $*
    echo '===== tail $PDFHIST ====='
    tail $PDFHIST
    echo '========================='
  }
  
  [[ $TXT || $SSH_TTY ]] && { less "$*"; exit 0; }

  [[ $PTH ]] && { realpath "$*"; exit 0; }

  [[ "$*" == *gz ]] && {
    gzip -cd "$*" | zathura -
	  exit 0
  } || {
    $MUPDF "$*" &>/dev/null
	  exit 0
  }
}

searchPDF() { # when $PATTERN is a random string, i.e. chkPATTERN returns 2.

  [[ "$DEBUG" ]] && {
	  echo '[searchPDF] $1 is:' ${1:-empty}
  }

  local PATTERN="$*"

  #Searching in $CWD
  local PDFFILE=$(sk $SKOPTS < <(fd $FDOPTS -e pdf.gz -e pdf \
                                    "${PATTERN##*/}") )

  [[ $DEBUG ]] && echo '[searchPDF] $PDFFILE in $CWD is:' ${PDFFILE:-empty}
  
  [[ "$PDFFILE" ]] || { # if no matching found in CWD 
    # Searching in $PDFHIST
    local HIST=$(sk $SKOPTS < <(rg $RGOPTS "${PATTERN##*/}" $PDFHIST) )

    [[ "$HIST" ]] || { # not found in $PDFHIST
        [[ $DEBUG ]] && echo '[searchPDF]' $PATTERN: No match found in neither $PWD nor $PDFHIST.
        exit 0
      }

    openPDF "$HIST" # found in $PDFHIST
  }

  # if Found in CWD
  [ $DEBUG ] && echo '[searchPDF] $PATTERN is found in' $PWD

  # if not in PDFHIST, add it
  # local FULLPTH="$(realpath "$PDFFILE")"
  # rg -qF "$FULLPTH" "$PDFHIST" || {
  #     echo "$FULLPTH" >> "$PDFHIST"
  #     echo "$FULLPTH" is added into $PDFHIST
  #   }

  # [ $DEBUG ] && tail $PDFHIST

  openPDF "$PDFFILE"
}

while getopts :Dtep OPT; do
  case $OPT in
    t) TXT="Y" ;;
    e) vi "$PDFHIST"; exit 0 ;;
    p) PTH="Y" ;;
    D) DEBUG="Y" ;;
    *) usage ;;
  esac
done
shift $((OPTIND - 1))
OPTIND=1

[[ "$DEBUG" ]] && echo '[DEBUG] After getopts, $* is:' ${*:-empty}

chkPATTERN "$*"

case $? in
	0) #empty $*, choose a PDF in $PDFHIST
		openPDF "$(sk <$PDFHIST $SKOPTS)"
		exit 0
		;;
	1) #file found in $CWD
		openPDF "$*"
		exit 0
		;;
	2)
		searchPDF "$*"
		exit 0
		;;
esac
