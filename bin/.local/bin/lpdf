#!/bin/bash

usage(){
	cat <<EOF
${0##*/} - A lazy PDF viewer.

Usage: ${0##*/} [-hDtcn] [pattern string]
	   -h  help
	   -D  enable debug mode
	   -t  text mode
	   -c  edit $HOME/.pdf_history file
	   -n  output full path to the file
EOF
}

MUPDF="$(command -v mupdf-gl) -C FDF6E3" || MUPDF="$(command -v mupdf) -C FDF6E3"
V="setsid -f $MUPDF"
PDFHIST="$HOME/.pdf_history"
DEBUG=""

[ -e "$PDFHIST" ] || touch "$PDFHIST"

while getopts :Dhtcn OPT; do
	case $OPT in
		t) V="less" ;;
		c) vim "$PDFHIST"; exit 0 ;;
		n) V="realpath" ;;
		D) DEBUG="YES" ;;
		h) usage; exit 0 ;;
		?) usage; exit 1 ;;
	esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

PATTERN="$*"

chkPATTERN(){
	# empty
	[[ "$PATTERN" ]] || return 0;

	# valid file, e.g. /tmp/tmp.pdf or tmp.pdf
	[[ $(file --mime-type -b "$PATTERN") == application/pdf ]] && return 1;

	# any string
	return 2;
}

searchPDF(){ # when $PATTERN is a random string
	PDFFILE=$(sk < <(fd --no-ignore \
						--max-depth 3 \
						--fixed-strings \
						--extension pdf.gz \
						--extension pdf \
						"${PATTERN##*/}") \
				 --exact --select-1 --exit-0 \
				 --ansi --color=always \
				 --no-multi \
				 --keep-right)

	[ $DEBUG ] && echo "[DEBUG]: PDFFILE=$PDFFILE"
	
	# if no matching found in CWD
	[[ "$PDFFILE" ]] || { # check in $PDFHIST
		HIST=$(sk < <(rg --no-line-number \
						 --fixed-strings \
						 --max-columns=0 \
						 "$PATTERN" $PDFHIST) \
				  --exact --select-1 --exit-0 \
				  --ansi --color=always \
				  --no-multi \
				  --keep-right)

		[[ "$HIST" ]] || { # not found in $PDFHIST
			echo "$PATTERN": No match found in neither $PWD nor $PDFHIST.
			exit 1
		}

		if [[ "$HIST" == *gz ]] && [[ "$V" != "less" ]]; then
			gzip -cd "$HIST" | zathura -
			exit 0
		else
			$V "$HIST" 2>/dev/null
			exit 0
		fi
	}

	# Found in CWD
	[ $DEBUG ] && echo "[DEBUG]: found in $PWD"
	# if not in PDFHIST, add it
	rg -qF "$(realpath "$PDFFILE")" "$PDFHIST" || \
		realpath "$PDFFILE" >> "$PDFHIST"

	[ $DEBUG ] && tail $PDFHIST
	
	if [[ "$PDFFILE" == *gz ]] && [[ "$V" != "less" ]]; then
		gzip -cd "$PDFFILE" | zathura -
		exit 0
	else
		$V "$PDFFILE" 2>/dev/null
		exit 0
	fi
}

chkPATTERN

case $? in
	0) sk < $PDFHIST \
		  --bind "enter:execute($V {})+abort" \
		  --exact --select-1 --exit-0 \
		  --ansi --color=always \
		  --no-multi \
		  --keep-right
	   exit 0
	   ;; 
	1) $V "$PATTERN"; exit 0
	   ;;
	*) searchPDF; exit 0		
esac
