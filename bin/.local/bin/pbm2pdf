#!/bin/bash

cmdchk mkbitmap

usage(){
	cat <<EOF
${0##*/} - Convert any image into a monochrome PDF file with optional text annotation.

Usage: ${0##*/} [-h -i -x] [-f Filter] [-t Threshold] [-T text] [-c x,y] [-F font size] <Image>

	   -h - help
	   -i - mkbitmap -i
	   -x - invoke potrace
   Filter - man mkbitmap for details
Threshold - man mkbitmap for details
     text - text to be added
      x,y - coordinate of text to be added, default to '+300+30'
font size - default to 22
EOF
}

cleanup(){
	rm -f "$TIF" "$PBM"
}

trap cleanup EXIT

#######color code########
ERR="31m"     # red
SUCCESS="32m" # green
WARN="33m"    # yellow
INFO="36m"    # blue

colorEcho(){
    echo -e "\033[${1}${@:2}\033[0m" 1>& 2
}

MKBMP=$(command -v mkbitmap)
TRACE=''

while getopts :hixf:t:T:c:S:F: OPT; do
	case $OPT in
		h) usage; exit 0 ;;
		i) MKBMP="$MKBMP -i" ;;
		x) TRACE="yes" ;;
		f) F="$OPTARG" ;;
		t) T="$OPTARG" ;;
		T) TXT="$OPTARG" ;;
		c) XY="$OPTARG" ;;
		S) FS="$OPTARG" ;;
		F) FN="$OPTARG" ;;
		?) usage; exit 2
	esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

IMG="$@"
[[ -f "$IMG" ]] || { colorEcho $ERR "Image <$IMG> not found!"; usage; exit 1; }

# https://tecadmin.net/how-to-extract-filename-extension-in-shell-script/
BASE="${IMG%.*}"
PPM="$BASE.ppm"
PBM="$BASE.pbm"
TIF="$BASE.tif"
PDF="$BASE.pdf"

mkdir -p trash

TYPE=$(file -b --extension "$IMG")
echo -n "$TYPE" '-> PPM...'

case $TYPE in
    *jpg* ) cmdchk jpegtopnm
        jpegtopnm -quiet "$IMG" > "$PPM"
		mv "$IMG" trash
        ;;
    *png* ) cmdchk pngtopam
		pngtopam -mix -background="#FFF" "$IMG" > "$PPM"
		mv "$IMG" trash
		;;
	*webp* ) cmdchk dwebp 
		dwebp "$IMG" -ppm -o "$PPM"
		mv "$IMG" trash
		;;
	*ppm*|*pgm*|*pbm* )
		;;
	* ) cmdchk convert
		convert "$IMG" "$PPM"
		mv "$IMG" trash
esac && echo 'done.' || echo 'failed.'

echo -n 'PPM -> PBM...'
$MKBMP -f${F:-128} -t${T:-.4} -o "$PBM" "$PPM" && echo 'done.' || echo 'failed.'

[[ "$TXT" ]] && {
	cmdchk mogrify
	echo -n 'Annotating the PBM file...'
	mogrify -pointsize ${FS:-22} -font ${FN:-Noto-Sans-CJK-SC} -annotate ${XY:-+300+30} "$TXT" "$PBM" && echo 'done.' || echo 'failed.'
}

[[ "$TRACE" ]] && {
	cmdchk potrace
	echo -n 'Run potrace on the PBM file...'
	potrace --tight -bpdf "$PBM" && echo 'done.' || echo 'failed.'
} || {
	cmdchk ppm2tiff
	echo -n 'PBM -> Tiff -> PDF...'
	ppm2tiff -c none "$PBM" "$TIF" && \
		tiff2pdf -zFo "$PDF" "$TIF" && \
		echo 'done.' || echo 'failed.'
}

