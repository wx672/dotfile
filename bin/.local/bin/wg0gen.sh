#!/bin/bash

usage(){
	cat <<EOF
${0##*/} - Generating the /etc/wireguard/wg0.conf file for a client. Add a new peer in server (cs6) config.

USAGE: 
  ${0##*/} [OPTIONS]

VALID OPTIONS:

  -h help

  -o <output file name>. Default to wg0.conf.

  -a <Client IP address>. If missing, the 'Address' field will be left blank:

      [Interface]
      Address = <172.16.200.x/22>

  -k <Server public key>. If missing, the 'PublicKey' field will be left blank:

      [Peer]
      PublicKey = <Server public key>
EOF
}

command -v wg &>/dev/null || {
	cat <<EOF
wg is missing!
Make sure the wireguard-tools package is installed before proceeding.
Check the Debian wiki page for more information:
  - https://wiki.debian.org/WireGuard?action=show&redirect=Wireguard
EOF
	exit 1
}

WGDIR="/etc/wireguard"
PRIVATEKEY_CLIENT=$(wg genkey)
PUBKEY_CLIENT=$(echo $PRIVATEKEY_CLIENT | wg pubkey)
PUBKEY_SERVER=""
IP_CLIENT=""
OUTFILE="wg0.conf"

while getopts :ho:k:a: OPT; do
	case $OPT in
		a) IP_CLIENT="$OPTARG" ;;
		k) PUBKEY_SERVER="$OPTARG" ;;
		o) OUTFILE="$OPTARG" ;;
		h) usage; exit 0 ;;
		?) usage; exit 1 ;;
	esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

cat <<EOF | tee "/tmp/$OUTFILE"
######## Client side config file generated by ${0##*/} ########
######## Date: $(date +%Y-%m-%d-%H:%M) ################################
[Interface]
PrivateKey = $PRIVATEKEY_CLIENT
Address = $IP_CLIENT

[Peer]
PublicKey = $PUBKEY_SERVER
AllowIPs = 172.16.200.0/22
AllowIPs = 218.194.100.0/20
Endpoint = 39.129.9.40:51820
PersistentKeepalive = 20
######## End of config ########

EOF

cat <<EOF
The newly generated wg0.conf file is in /tmp/ dir.

At the client side, The variable 'net.ipv4.ip_forward' has to be set to '1' in /etc/sysctl.conf! The following two commands will do:
##############################################################
sudo sed -i '/net\.ipv4\.ip_forward/ s/0/1/' /etc/sysctl.conf 
sudo sysctl -p
##############################################################
EOF

# Add a peer in server config
[[ $(hostname) == cs6.swfu.edu.cn ]] && {
	cat <<EOF | sudo tee --append "$WGDIR/wg0.conf"
######## $(date +%Y%m%d) ########
[Peer]
PublicKey = $PUBKEY_CLIENT
AllowedIPs = $IP_CLIENT

EOF

echo "A new peer has been appended to $WGDIR/wg0.conf!"
}

# Enable ip_forwarding
# [ -f "/etc/sysctl.conf" ] || {
# 	cat <<EOF
# The very important file /etc/sysctl.conf is missing!!!
# I don't know how to proceed. Quit...
# EOF
# 	exit 1
# }

# sudo sed -i '/net\.ipv4\.ip_forward/ s/0/1/' /etc/sysctl.conf 
# sudo sysctl -p

