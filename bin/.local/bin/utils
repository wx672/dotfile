#!/bin/bash

MUPDF="$(command -v mupdf) -C FDF6E3"
BROWSER="$(command -v x-www-browser)"
SAY="$(command -v espeak-ng)"
CS6="cs6.swfu.edu.cn"

skemoji()
{
	[[ "$2" ]] || { echo usage: "skemoji <search|emoji> <search string>"; return 1; }

	command -v uni &>/dev/null || {
		cat <<EOF
This script requires uni (https://github.com/arp242/uni)
EOF
		exit 1
	}

	command -v sk &>/dev/null || {
		cat <<EOF
This script requires skim (https://github.com/lotabout/skim)
EOF
		exit 1
	}

	command -v xsel &>/dev/null || {
		cat <<EOF
This script requires xsel (sudo apt install xsel)
EOF
		exit 1		
	}
	
	CMD="$1"
	case $CMD in
		s*) chosen=$(uni -quiet \
						 -f "%(char l:3)%(wide_padding)%(cpoint l:8)%(name t)(%(block t))" \
						 search "$2" | sk --exact \
										  --select-1 \
										  --exit-0 | choose 0)
			;;
		e*) chosen=$(uni -quiet emoji ${2:-all} | sort --random-sort | sk -e10 | choose 0)
			;;
		*) echo usage: "$0 <search|emoji> <search string>"; return 1
		   ;;
	esac

	[ "$chosen" ] || return

	printf "$chosen\n" && { xsel -bi <<<$chosen; }
	# xdotool type "$chosen"
	# notify-send "'$chosen' copied to clipboard."
}

play(){
	sk < <(fd -d 1 -e mp4 -e mkv -e webm -e m4a -e mp3 -e rmvb -e avi -e flv) \
	   --exact --bind "enter:execute(mpv {})+abort"
	
	return 0
}

gmaps(){
	QUERY=""
	for WORD in "$@"; do
		QUERY="$QUERY%20$WORD"
	done
	($BROWSER https://www.google.com/maps/search/$QUERY 2>/dev/null &)
}

ffshot(){ # screenshot
	ffmpeg -y -f x11grab -s 1920x1080 -r 1 -i "$DISPLAY" -vframes 1 /tmp/"$(date +%Y%m%d%H%M)".jpg &>/dev/null
}

ffrec(){ # screen recording lossy

    trap 'pkill screenkey' INT EXIT TERM ERR

    (screenkey --no-systray --opacity .3 --font-color red --font "Fira Code SemiBold" &)
    
	ffmpeg -f x11grab -s 1920x1080 -r 25 -i :0.0 \
		   -c:v libx264 -preset superfast \
		   "$(date +%Y%m%d%H%M)".mp4
}

ffrec_lossless(){ # screen recording losslessly (very large file!)
	ffmpeg -f x11grab -s 1920x1080 -r 30 -i :0.0 \
		   -c:v libx264rgb -crf 0 -preset superfast \
		   "$(date +%Y%m%d%H%M)".mkv
}

mp4(){ # convert $1 to mp4
	#  -preset ultrafast
	ffmpeg -i "$1" -an -c:v libx265 "$1".mp4
}

ffrec_overlay(){ # recording screen and webcam
	# man ffmpeg-filters
	# use 'ffplay -f v4l2 -list_formats all /dev/video0' to check for available video_size
	# 1280x720 960x540 848x480 640x480 640x360

	ffmpeg \
		-f x11grab -framerate 30 \
		-s "$(xdpyinfo | awk '/dimensions/ {print $2;}')" \
		-i "$DISPLAY" \
		-f alsa -i pulse \
		-f v4l2 -s 640x360 -framerate 30 -i /dev/video0 \
		-filter_complex "overlay=W-w:H-h" \
		-c:v libx264 -crf 0 -preset ultrafast -c:a aac -b:a 48k \
		"$(date +%Y%m%d%H%M)".mp4
}

ffcam(){ # capture webcam
	# use 'ffplay -f v4l2 -list_formats all /dev/video0' to check for available video_size
	#  -preset superfast
	ffmpeg -f v4l2 -s 640x480 -r 30 -i /dev/video0 \
		   -f alsa -i hw:1 \
		   -c:v libx264 -qp 0 -c:a aac -b:a 48k \
		   "$(date +%Y%m%d%H%M)".mp4
}

dict () { (/usr/bin/dict "$@" 2>&1 | bat;) }

# dingtalk () {
# 	(/opt/apps/com.alibabainc.dingtalk/files/Elevator.sh &>/dev/null)
# }

e(){
	# if emacsclient -e "(if (> (length (frame-list)) 1) 't)" | /bin/grep -q t; then
	if wmctrl -xa emacs; then
		[ "$1" ] && emacsclient -n "$@" || emacsclient -ne "(recentf-open-files)"
	else
		[ "$1" ] && emacsclient -nc "$@" || emacsclient -nce "(recentf-open-files)"
	fi
}

emacs() { 
	e "$@"; 
}

# viewing markdown file in w3m. an alternative to mdless/mdcat
mdview(){
	#(cmark "$1" | w3m -T text/html)
	w3m -T text/html < <(cmark "$1")
}

say(){
	while getopts :v: OPT; do
		case $OPT in
			v) voice="$OPTARG" ;;
			*) echo "Usage: say [-h] [-v <voice>] words"; return 0 ;;
		esac
	done
	shift $(( OPTIND - 1 ))
	OPTIND=1
	
	($SAY -s140 -p70 -v${voice:="en-gb"}  "$*";)
}

propstring () {
  echo -n 'Property '
  xprop WM_CLASS | sed 's/.*"\(.*\)", "\(.*\)".*/= "\1,\2" {/g'
  echo '}'
}

booksearch () {
	LIBPATH=$HOME/Calibre
	[[ "$1" ]] || { echo Usage: 'booksearch <keywords>'; return 1; }
	calibredb list -s "$@" --with-library="$LIBPATH"/Calibre1
	calibredb list -s "$@" --with-library="$LIBPATH"/Calibre2
	calibredb list -s "$@" --with-library="$LIBPATH"/Calibre3
}

searchbook () {
    (booksearch "$1")
}

pdf () {
    unoconv "$@"
}

ppt () {
	libreoffice --show "$@"
}

xls2x () { # xls -> xlsx
	libreoffice --convert-to xlsx "$1"
}

cs6(){
	local KEY=""
	local USER=""
	
	while getopts :i:u: OPT; do
		case $OPT in
			k)
				KEY="--ssh=\"ssh -i $OPTARG\""
				;;
			u)
				USER="$OPTARG"
				;;
			*)
				echo "Usage: cs6 [-k key] [-u user]";
				return 1
		esac
	done
	shift $(( OPTIND - 1 ))
	OPTIND=1
		
	[ $DISPLAY ] && {
		(st -e mosh ${KEY} ${USER:-wx672}@cs6.swfu.edu.cn &)
	} || {
		mosh ${KEY} ${USER:-wx672}@cs6.swfu.edu.cn
	}
}

rcb () { # remote clipboard
    
    local PORT=${1:-33333}

    echo fetching from port "$PORT" ...

    # at remote side (cs6) do, for example, 'ls *.mkv | nc -4l 33333'
    { nc -4 cs6 "$PORT" || echo nc failed.; } | xsel -bi

    xsel -bo
}

cs6v(){
    url="https://cs6.swfu.edu.cn/~wx672"
    base=${1:-tmp}
    movies=$(xsel -bo)

	[[ "$movies" ]] || { echo "Empty clipboard. Quit..."; return 1;	}
	
    cat <<EOF
Files to be downloaded:

$movies

EOF

    for m in $movies; do
        echo Downloading "$url"/"$base"/"$m" ...
        aria2c --no-conf --check-certificate=false -x16 "$url"/"$base"/"$m"
    done    
}

cs6r(){
	rsync -avLP --inplace --append cs6:public_html/"$1" .
}

mdcheat(){
	mdless <(cheat $1)
}

# https://stackoverflow.com/questions/660613/how-do-you-hide-the-mouse-pointer-under-linux-x11
setmouse () {
	for i in $(DISPLAY=":0" xinput | grep Mouse | cut -d"=" -f2 | cut -b-2)
	do
		DISPLAY=":0" xinput --"$1" "$i"
	done
}

moff () {
   DISPLAY=":0" xdotool mousemove 3840 2160 # use xrandr to find out
   setmouse disable
}

mon () {
	DISPLAY=":0" xdotool mousemove 1366 768 # use xrandr to find out
	setmouse enable
}

settouchpad() {
	for i in $(DISPLAY=":0" xinput | grep Touchpad | cut -d"=" -f2 | cut -b-2)
	do
		DISPLAY=":0" xinput --"$1" "$i"
	done
}

toff () { # touchpad
	DISPLAY=":0" xdotool mousemove 3840 2160 # use xrandr to find out
	settouchpad disable
}

ton () {
	DISPLAY=":0" xdotool mousemove 1366 768 # use xrandr to find out
	settouchpad enable
}

loremipsum () {
	if [ "${1}" = "" ] || [ "${2}" = "" ]; then
		echo "Usage: loremipsum <paragraphs|sentences> <integer>"
	else
		curl -s http://metaphorpsum.com/"${1}"/"${2}" && printf "\n"
	fi
}

proxy () {
	cat <<EOF
	pon/poff - Switch on/off proxy

	Current settings:
		 http_proxy = $http_proxy
		https_proxy = $https_proxy
EOF
}

poff ()
{
	echo -n 'unset http_proxy HTTP_PROXY https_proxy HTTPs_PROXY... '
    unset http_proxy HTTP_PROXY https_proxy HTTPs_PROXY
	echo done.
}

pon ()
{
	echo Turn on proxy...
    http_proxy=http://127.0.0.1:${1:-1081}/
    HTTP_PROXY=$http_proxy
    https_proxy=$http_proxy
    HTTPS_PROXY=$https_proxy
    export http_proxy https_proxy HTTP_PROXY HTTPS_PROXY
	cat <<EOF
	http_proxy=$http_proxy
	HTTP_PROXY=$http_proxy
	https_proxy=$http_proxy
	HTTPS_PROXY=$https_proxy
EOF
}
