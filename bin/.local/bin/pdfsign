#!/bin/bash

usage(){
    cat <<EOF
USAGE: ${0##*/} [-hD] [-p pattern] [-c xshift,yshift] [-d ysep] [-w width] [-s scale] [-t y,m,d] [-S picture|text] <background>

EXAMPLES:
1. ${0##*/} -p'签.*章' -t'2024,6,7' -S'mysig.pdf'  pg_0001.pdf
   ${0##*/} -p'签.*章' -t'2024,6,7' -S'\sig 王晓林' pg_0002.pdf
  
2. ${0##*/} -p'考核方式' -S'开卷机试' -c'60,-2' -s .9 pg_0001-signed.pdf

3. ${0##*/} -w10cm -c'-20,-50' -S'../analysis-improve.pdf' os-analysis.pdf
   ${0##*/} -p'考试形式' -S'开卷机试' -c'50,25' -d'110' -t'2023/,12/,25' os-analysis-signed.pdf


background - paper to sign
        -h - help
		-D - Enable debugging outputs and grid
		-p - search pattern

        -S - signature picture or text
		   	 Default='{.,..}/wangxiaolin.pdf' if found

        -c - 'xshift,yshift' 
		   	 Default to '28,-18' in pt if signed with picture
			 Default to '28,-25' in pt if signed with \sig font text

		-d - ysep, shift of the "date field". Default to 180pt

        -t - timestamp, e.g. '2020,5,8'
        -w - width of signature picture. Default to '1cm'
        -s - scale of signature text. Default to '1'
EOF
}

cleanup(){
	[[ "$DEBUG" ]] || { rm -f "$AUX" "$LOG" "$TEXFILE" "$DEBUGFILE"; }
}

#######color code########
ERR="31m"     # red
SUCCESS="36m" # green
#WARN="32m"    # yellow
INFO="34m"    # blue

colorEcho(){
    echo -e "\033[${1}${@:2}\033[0m" 1>&2
}

# pdftotext -tsv os-marks.pdf - | rg -N "签.*章" | head -1 | choose -o ',' 6 7
# pdftotext -tsv os-marks.pdf - | rg -N "考试.*日" | head -1 | choose -o ',' 6 7
getCoordinate(){
	XY=$(pdftotext -tsv "$BG" - | \
			 rg -N "$PATN" | head -1 | \
			 choose -o ',' 6 7)

	[[ -z "$XY" ]] && { colorEcho $ERR 'Failed to get coordinate (XY)!'; exit -1; }

	X=${XY%,*}pt
	Y=${XY##*,}pt

	[[ "$DEBUG" ]] && {
		echo "XY = $XY" > $DEBUGFILE
		echo "X = $X" >> $DEBUGFILE
		echo "Y = $Y" >> $DEBUGFILE
	}	
}

signit(){
	cat <<EOF > "$TEXFILE"
\documentclass[tikz]{standalone}
\usetikzlibrary{backgrounds,positioning}
\usepackage[scheme=plain]{ctex}
\newCJKfontfamily\sig{signature}
\newfontfamily\purisa{Purisa}

\begin{document}
\begin{tikzpicture}[inner sep=0,anchor=north west,yscale=-1]
    \node (bg) at (0,0) {\includegraphics[width=\paperwidth]{$BG}};

	\begin{scope}
EOF

	[[ "$DEBUG" ]] && {
		echo "Draw grid for debugging..." >> $DEBUGFILE

		cat <<EOF >> "$TEXFILE"
		%%% grid
		\draw[help lines,red,step=25pt] (0,0) grid (600pt,850pt);
		\draw[thin] (0,0) rectangle (595pt,842pt); % a4: 595x842
		\foreach \x in {0,50,100,...,600} { \node at (\x pt,0) {\x}; }%
		\foreach \y in {0,50,100,...,850} { \node at (0,\y pt) {\y}; }%
EOF
	}
	
	if [[ -f "$SIG" ]]
	then # sign with the picture. $XY is from getCoordinate()
		cat <<EOF >> "$TEXFILE"
		\node (sig) at (${X:-550pt},${Y:-800pt}) [%
			  xshift=${XSHIFT:-28}pt, yshift=${YSHIFT:--18}pt] {%
			  \includegraphics[width=${WIDTH:-1cm}]{$SIG}};
EOF
	else # sign with text
		cat <<EOF >> "$TEXFILE"
		\node (sig) at (${X:-550pt},${Y:-800pt}) [%
			  xshift=${XSHIFT:-28}pt, yshift=${YSHIFT:--25}pt,%
			  scale=${SIGSCALE:-1}] {$SIG};
EOF
	fi
	[[ "$DEBUG" ]] && {
		cat <<EOF >> $DEBUGFILE
Signed with <$SIG>
	   at (${X:-550pt},${Y:-800pt})
	   [xshift=${XSHIFT:-28}pt, yshift=${YSHIFT:--18}pt, scale=${SIGSCALE:-1}]
	   Picture width=${WIDTH:-1cm} if signed with a picture

	   yshift=${YSHIFT:--25}pt if signed with text
EOF
	}

	[[ "$Year" ]] && {
		cat<<EOF >> "$TEXFILE";
		\node [right=${YSEP:-183}pt of sig, yshift=-3pt, font=\purisa] {%
		  $Year\hspace{1.5em}%
		  \makebox[1em][c]{$Month}\quad%
		  \makebox[1em][c]{$Day}};%
EOF
		[[ "$DEBUG" ]] && {
			cat <<EOF >> $DEBUGFILE
<$Year,$Month,$Day> is added at offset: (${YSEP:-180}pt)
EOF
		}
	}

	cat <<EOF >> "$TEXFILE"
    \end{scope}
	\end{tikzpicture}
\end{document}
EOF
	[[ "$DEBUG" ]] && {
		cat "$DEBUGFILE"
		cat "$TEXFILE"
	}
}

trap cleanup EXIT

# defaults
[[ -e wangxiaolin.pdf ]] && SIG='wangxiaolin.pdf'
[[ -e ../wangxiaolin.pdf ]] && SIG='../wangxiaolin.pdf'

unset X Y XY XSHIFT YSHIFT YSEP MSEP DSEP DEBUG SCALE WIDTH PATN

while getopts :hDc:d:p:s:w:t:S: OPT; do
	case $OPT in
		h) usage; exit 0 ;;
		D) DEBUG='YES' ;;
		c) XSHIFT=${OPTARG%,*}
		   YSHIFT=${OPTARG#*,}
		   ;;
		d) YSEP="$OPTARG" ;;
		p) PATN="$OPTARG" ;;
		s) SIGSCALE="$OPTARG" ;;
		w) WIDTH="$OPTARG" ;;
		t) Year=${OPTARG%%,*}
		   Month=${OPTARG#*,} && Month=${Month%,*}
		   Day=${OPTARG##*,}
		   ;;
		S) SIG="$OPTARG" ;;
		?) usage; exit 2
	esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

BG="$*"

[[ -f "$BG" ]] || { colorEcho $ERR "ERROR: <${BG:-BACKGROUND}> NOT FOUND."; usage; exit 1; }

DEBUGFILE="__DEBUG__"; > $DEBUGFILE
TEXFILE="${BG%.pdf}-signed.tex"; > $TEXFILE
PDF="${TEXFILE%.tex}.pdf"
LOG="${TEXFILE%.tex}.log"
AUX="${TEXFILE%.tex}.aux"

[[ "$PATN" ]] && getCoordinate

signit

[[ "$DEBUG" ]] && echo "Signing <$BG>..." >> $DEBUGFILE

colorEcho $INFO "lualatex $TEXFILE..."
lualatex "$TEXFILE" 1>/dev/null

[[ -f "$PDF" ]] || { colorEcho $ERR "Failed generating PDF file. Please check <$LOG> file for details"; exit 5;}

{ colorEcho $SUCCESS 'DONE!'; ls -l "$PDF"; xdg-open "$PDF"; }
